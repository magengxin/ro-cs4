$(function(){function t(t){return $.ajax({url:t,dataType:"jsonp",type:"get"})}function n(){t(g).then(function(t){f=t.is_login,b=t.backcdk_enable,h=t.backcdk_get,m=t.finalcdk_enable,p=t.finalcdk_get,v=t.today_sign_cdk_enable,$("#pfid").text(t.pfid),o(t.cdkget_cnt),a(t.cdk_history),c(f)})}function c(t){t?(d.hide(),r.show()):(d.show(),r.hide())}function o(n){$(".can-sign").removeClass("can-sign"),!n&&f&&$("[data-day=1]").addClass("can-sign").addClass("animated");for(var c=1;c<=n;c++)$("[data-day="+c+"]").addClass("day-cdk-get"),c==n&&c<7&&v&&$("[data-day="+(c+1)+"]").addClass("can-sign").addClass("animated");7==n&&$(".sign8").addClass("can-sign"),$(".icon-btn-receive").off("click").click(function(){if(!f)return toast("未登录");var c=n+1;c>1&&c<8&&(c=1),8==c&&(c=99),t(u+"?ktype="+c).then(function(t){$(".mask,.userback-sgin-state").show(),"0"==t.ret_code&&($(".sign-code").text("CDK:"+t.cdk),v=!1,o(n+1),99==c&&(m=1))})}),p&&$('[data-day="f"]')}function a(t){var n="";$.each(t,function(c,o){n+="<li>"+o.kname+"：CDK-"+o.cdk+"</li>","0"==o.ktype&&$(".usercdk-code").text("CDK:"+o.cdk),c==t.length-1&&$(".sign-code").text("CDK:"+o.cdk)}),$("#historyul").html(n)}$(".mask,.icon-btn-close").on("click",function(){$(".mask,.icon-popover-bg").hide()});var e=$(".icon-btn-receive"),i=$(".view-index"),s=$(".sign-container").offset();i.scroll(function(){i.prop("scrollTop"),i.prop("scrollTop")+140>s.top?e.show():e.hide()});var d=$(".btn-login"),r=$(".btn-loginout-box"),l=($(".login-bg"),$(".mask"));d.click(function(){console.log("11"),$(".mask,.login-bg").show()}),$(".mask,.icon-btn-close").click(function(){$(".mask,.login-bg").hide()}),$(".icon-btn-records").click(function(){if(!f)return $(".login-bg,.mask,.btn-login").show(),toast("请先登录");$(".mask,.records-bg").show()}),l.click(function(){$(".mask,.records-bg").hide()});var k="http://dcms.thedream.cc/ro/userback",g=k+"/stat",u=k+"/cdk",f=!1,b=!1,h=!1,m=!1,p=!1,v=0;n(),r.click(function(){t("http://dcms.thedream.cc/ro/userback/logout").then(function(t){"0"==t.ret_code&&(f=0,c(f),$(".day-cdk-get").removeClass("day-cdk-get"),$(".can-sign").removeClass("can-sign"))})});var y=$(".icon-btn-login-button"),C=$(".phone"),_=$(".password");y.click(function(){var t=C.val().trim(),o=_.val().trim();return t?o?void $.ajax({type:"post",dataType:"jsonp",url:"http://dcms.thedream.cc/ro/userback/login",data:{uid:t,upw:$.crypto(o)},success:function(t,o,a){if(0!=t.ret_code)return toast(t.ret_msg);f=1,$(".login-bg,.mask,.btn-login").hide(),c(f),n()}}):toast("请输入密码"):toast("请输入骏梦账号")}),$(".icon-btn-userback").on("click",function(){if(!f)return $(".login-bg,.mask,.btn-login").show(),toast("请先登录");if(!b)return void $(".mask,.fail-state").show();if(h)return void $(".mask,.userback-state").show();var n=$(".usercdk-code");$(".sign-code"),t(u+"?ktype=0").then(function(t){"0"==t.ret_code&&(h=!0,toast("CKD:"+t.cdk),$(".mask,.userback-state").show(),n.text("CKD:"+t.cdk),$$signCode.text("CKD:"+t.cdk))})})});